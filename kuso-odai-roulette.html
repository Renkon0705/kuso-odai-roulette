<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>クソお題ルーレット</title>

<style>
body {
  font-family: sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
  padding: 30px;
}

.slot-area {
  display: flex;
  justify-content: center;
  gap: 20px;
}

.window {
  height: 60px;
  width: 220px;
  overflow: hidden;
  border: 2px solid #fff;
  background: #000;
  position: relative;
}

.reel {
  position: absolute;
  width: 100%;
}

.item {
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}

button {
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>クソお題ルーレット</h1>
<div>ver1.1.2</div>

<div class="slot-area">
  <div>
    <div class="window"><div class="reel" id="reel0"></div></div>
    <button onclick="stop(0)">STOP</button>
  </div>
  <div>
    <div class="window"><div class="reel" id="reel1"></div></div>
    <button onclick="stop(1)">STOP</button>
  </div>
  <div>
    <div class="window"><div class="reel" id="reel2"></div></div>
    <button onclick="stop(2)">STOP</button>
  </div>
</div>

<button onclick="start()">回す</button>

<div id="history"></div>

<script>
const SHEET_ID = "1l2aSZI_c9Ae9O4bBD8U1YBt0JiAbg75ahg1AAhaSqqU";
const GID = "1966770932";

const reels = [];
const data = [[], [], []];
const timers = [];
const speed = [8,8,8];
const stopping = [false,false,false];
const stopped = [false,false,false];
const itemH = 60;

fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`)
  .then(r => r.text())
  .then(t => {
    t.split("\n").slice(1).forEach(row => {
      const c = row.split(",");
      if(c[1]) data[0].push(c[1]);
      if(c[2]) data[1].push(c[2]);
      if(c[3]) data[2].push(c[3]);
    });
    init();
  });

function init(){
  for(let i=0;i<3;i++){
    reels[i]=document.getElementById("reel"+i);
    reels[i].innerHTML="";
    [...data[i],...data[i]].forEach(v=>{
      const d=document.createElement("div");
      d.className="item";
      d.textContent=v;
      reels[i].appendChild(d);
    });
    reels[i].pos=0;
  }
}

function start(){
  for(let i=0;i<3;i++){
    clearInterval(timers[i]);
    stopping[i]=false;
    stopped[i]=false;
    speed[i]=8;
    spin(i);
  }
}

function spin(i){
  const max = data[i].length * itemH;
  timers[i]=setInterval(()=>{
    reels[i].pos -= 6;
    if(-reels[i].pos >= max) reels[i].pos = 0;
    reels[i].style.top = reels[i].pos+"px";

    if(stopping[i]){
      speed[i]*=1.08;
      clearInterval(timers[i]);
      timers[i]=setInterval(()=>spin(i),speed[i]);
      if(speed[i]>180){
        clearInterval(timers[i]);
        const idx = Math.floor(Math.random()*data[i].length);
        reels[i].pos = -(idx*itemH);
        reels[i].style.top = reels[i].pos+"px";
        stopped[i]=true;
        check();
      }
    }
  },speed[i]);
}

function stop(i){
  if(!stopped[i]) stopping[i]=true;
}

function check(){
  if(stopped.every(v=>v)){
    const res=[0,1,2].map(i=>{
      const idx=Math.abs(reels[i].pos/itemH);
      return data[i][idx];
    }).join(" × ");
    const d=document.createElement("div");
    d.textContent=res;
    document.getElementById("history").prepend(d);
  }
}
</script>

</body>
</html>
